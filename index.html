<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eternal Ember ‚ù§Ô∏è</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
<style>
  body { margin: 0; overflow: hidden; background: black; }
</style>
</head>
<body>

<script>
/* =========================
   TAMANHO DO MAPA
========================= */
const MAP_WIDTH = 1200;
const MAP_HEIGHT = 900;

/* =========================
   ESTADOS
========================= */
const STATE_MENU = 0;
const STATE_PLAY = 1;
const STATE_PAUSE = 2;
const STATE_GAMEOVER = 3;
let gameState = STATE_MENU;

/* =========================
   VARI√ÅVEIS
========================= */
let player, enemies=[], bullets=[], fires=[], hearts=[];
let walls=[], door=null;
let camX=0, camY=0;

let ammo=10, maxAmmo=10;
let life=10;
let level=1;
let anim=0;

let reloadCD=0;
let hitCD=0;

/* =========================
   SPRITES
========================= */
let catIdle, catMove, catNoAmmo;
let enemyFly, enemyFire;
let heartImg, bulletImg;

/* =========================
   PRELOAD
========================= */
function preload(){
  catIdle = loadImage("sprites/cat_idle.png");
  catMove = loadImage("sprites/cat_move.png");
  catNoAmmo = loadImage("sprites/cat_idle_noammo.png");
  enemyFly = loadImage("sprites/enemy_fly.png");
  enemyFire = loadImage("sprites/enemy_fire.png");
  heartImg = loadImage("sprites/heart.png");
  bulletImg = loadImage("sprites/hero_bullet.png");
}

/* =========================
   SPRITESHEET
========================= */
function drawSprite(img,x,y,w,h,f,tf){
  let fw = img.width/tf;
  image(img,x,y,w,h,f*fw,0,fw,img.height);
}

/* =========================
   SETUP
========================= */
function setup(){
  createCanvas(windowWidth,windowHeight);
  player={ x:600,y:500,w:40,h:40,speed:3 };
}

/* =========================
   START
========================= */
function startGame(){
  level=1;
  life=10;
  ammo=maxAmmo;
  loadLevel();
  gameState=STATE_PLAY;
}

/* =========================
   FASE
========================= */
function loadLevel(){
  enemies=[]; bullets=[]; fires=[]; hearts=[];
  door=null;

  walls=[
    {x:300,y:200,w:20,h:700},
    {x:600,y:300,w:400,h:20},
    {x:900,y:400,w:20,h:700}
  ];

  for(let i=0;i<level+2;i++){
    enemies.push({
      x:random(400,1000),
      y:random(400,800),
      life:5,
      cd:random(60)
    });
  }

  hearts.push({x:500,y:600});
}

/* =========================
   DRAW
========================= */
function draw(){
  background(0);

  if(gameState===STATE_MENU){ drawMenu(); return; }
  if(gameState===STATE_PAUSE){ drawGame(true); drawPause(); return; }
  if(gameState===STATE_GAMEOVER){ drawGame(true); drawGameOver(); return; }

  drawGame(false);
}

/* =========================
   GAME
========================= */
function drawGame(freeze){
  if(!freeze){
    if(reloadCD>0) reloadCD--;
    if(hitCD>0) hitCD--;
  }

  camX = constrain(player.x - width/2, 0, MAP_WIDTH - width);
  camY = constrain(player.y - height/2, 0, MAP_HEIGHT - height);

  if(MAP_WIDTH < width) camX = -(width - MAP_WIDTH)/2;
  if(MAP_HEIGHT < height) camY = -(height - MAP_HEIGHT)/2;

  push();
  translate(-camX,-camY);

  drawWalls();
  drawDoor();
  drawHearts();
  drawEnemies(freeze);
  drawFires(freeze);
  drawBullets(freeze);
  drawPlayer(freeze);

  pop();
  drawHUD();
}

/* =========================
   MENU / PAUSE / GAMEOVER
========================= */
function drawMenu(){
  fill(255);
  textAlign(CENTER,CENTER);
  textSize(48);
  text("ETERNAL EMBER",width/2,height/2-80);
  textSize(20);
  text("Clique para come√ßar",width/2,height/2);
}

function drawPause(){
  fill(0,180); rect(0,0,width,height);
  fill(255); textSize(40);
  textAlign(CENTER,CENTER);
  text("PAUSADO",width/2,height/2);
}

function drawGameOver(){
  fill(0,200); rect(0,0,width,height);
  fill(255,0,0); textSize(40);
  textAlign(CENTER,CENTER);
  text("GAME OVER",width/2,height/2);
}

/* =========================
   PLAYER
========================= */
function drawPlayer(freeze){
  if(!freeze) anim=(anim+0.2)%8;

  let nx=player.x, ny=player.y;

  if(!freeze){
    if(keyIsDown(65)) nx-=player.speed;
    if(keyIsDown(68)) nx+=player.speed;
    if(keyIsDown(87)) ny-=player.speed;
    if(keyIsDown(83)) ny+=player.speed;
  }

  if(!collide(nx,player.y)) player.x=nx;
  if(!collide(player.x,ny)) player.y=ny;

  let moving = keyIsDown(65)||keyIsDown(68)||keyIsDown(87)||keyIsDown(83);

  if(ammo<=0)
    drawSprite(catNoAmmo,player.x,player.y,40,40,floor(anim)%5,5);
  else if(moving)
    drawSprite(catMove,player.x,player.y,40,40,floor(anim)%8,8);
  else
    drawSprite(catIdle,player.x,player.y,40,40,floor(anim)%4,4);
}

/* =========================
   INPUTS
========================= */
function mousePressed(){
  if(gameState===STATE_MENU){ startGame(); return; }
  if(gameState!==STATE_PLAY) return;

  if(ammo>0){
    bullets.push({
      x:player.x+20,y:player.y+20,
      dx:(mouseX-width/2)*0.05,
      dy:(mouseY-height/2)*0.05
    });
    ammo--;
  }
}

function keyPressed(){
  if(keyCode===ESCAPE){
    if(gameState===STATE_PLAY) gameState=STATE_PAUSE;
    else if(gameState===STATE_PAUSE) gameState=STATE_PLAY;
  }

  if(gameState===STATE_PLAY && (key==='r'||key==='R') && reloadCD===0){
    ammo=maxAmmo;
    reloadCD=60;
  }
}

/* =========================
   RESTO
========================= */
function collide(x,y){
  for(let w of walls){
    if(x<w.x+w.w && x+player.w>w.x &&
       y<w.y+w.h && y+player.h>w.y) return true;
  }
  return false;
}

function drawBullets(freeze){
  for(let i=bullets.length-1;i>=0;i--){
    let b=bullets[i];
    if(!freeze){ b.x+=b.dx; b.y+=b.dy; }
    image(bulletImg,b.x,b.y,12,12);

    if(dist(b.x,b.y,player.x,player.y)<20){
      bullets.splice(i,1);
      break;
    }
  }
}

function drawEnemies(freeze){
  for(let e of enemies){
    if(!freeze){
      e.x+=(player.x-e.x)*0.01;
      e.y+=(player.y-e.y)*0.01;
    }
    drawSprite(enemyFly,e.x,e.y,40,40,floor(frameCount/8)%4,4);

    if(!freeze && e.cd--<=0){
      fires.push({
        x:e.x,y:e.y,
        dx:(player.x-e.x)*0.03,
        dy:(player.y-e.y)*0.03
      });
      e.cd=120;
    }
  }
}

function drawFires(freeze){
  for(let i=fires.length-1;i>=0;i--){
    let f=fires[i];
    if(!freeze){ f.x+=f.dx; f.y+=f.dy; }
    image(enemyFire,f.x,f.y,16,16);

    if(dist(f.x,f.y,player.x,player.y)<20 && hitCD===0){
      life--; hitCD=30;
      fires.splice(i,1);
      if(life<=0) gameState=STATE_GAMEOVER;
    }
  }
}

function drawHearts(){
  for(let i=hearts.length-1;i>=0;i--){
    let h=hearts[i];
    image(heartImg,h.x,h.y,28,28);
    if(dist(player.x,player.y,h.x,h.y)<30){
      life=min(10,life+1);
      hearts.splice(i,1);
    }
  }
}

function drawDoor(){
  if(!door) return;
  fill(0,0,255);
  rect(door.x,door.y,door.w,door.h);
  if(collide(door.x,door.y)){ level++; loadLevel(); }
}

function drawWalls(){
  fill(120);
  for(let w of walls) rect(w.x,w.y,w.w,w.h);
}

function drawHUD(){
  fill(255);
  textSize(16);
  text(`‚ù§Ô∏è Vida: ${life}`,20,30);
  text(`üî´ Ammo: ${ammo}/${maxAmmo}`,20,55);
  text(`Stage: ${level}`,20,80);
}

function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>

</body>
</html>
