<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eternal Ember ‚ù§Ô∏è</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.3/lib/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>

<script>
/* =========================
   VARI√ÅVEIS GERAIS
========================= */
let player, enemies = [], bullets = [], fires = [], hearts = [];
let camX = 0, camY = 0;

let ammo = 10, maxAmmo = 10;
let playerLife = 10;
let currentLevel = 1;

let animFrame = 0;

/* =========================
   SPRITES
========================= */
let catIdle, catMove, catReload, catShoot, catNoAmmo;
let enemyFly, enemyFire;
let heartImg, bulletImg;

/* =========================
   PRELOAD
========================= */
function preload() {
  catIdle   = loadImage("sprites/cat_idle.png");
  catMove   = loadImage("sprites/cat_move.png");
  catReload = loadImage("sprites/cat_reload.png");
  catShoot  = loadImage("sprites/cat_shooting.png");
  catNoAmmo = loadImage("sprites/cat_idle_noammo.png");

  enemyFly  = loadImage("sprites/enemy_fly.png");
  enemyFire = loadImage("sprites/enemy_fire.png");

  heartImg  = loadImage("sprites/heart.png");
  bulletImg = loadImage("sprites/hero_bullet.png");
}

/* =========================
   FUN√á√ÉO DE SPRITESHEET
========================= */
function drawSprite(img, x, y, w, h, frame, totalFrames) {
  let fw = img.width / totalFrames;
  image(
    img,
    x, y, w, h,
    frame * fw, 0,
    fw, img.height
  );
}

/* =========================
   SETUP
========================= */
function setup() {
  createCanvas(windowWidth, windowHeight);

  player = {
    x: 600,
    y: 500,
    w: 48,
    h: 48,
    speed: 3
  };

  loadLevel(currentLevel);
}

/* =========================
   FASES
========================= */
function loadLevel(level) {
  enemies = [];
  hearts = [];
  fires = [];
  bullets = [];

  let count = level + 2;

  for (let i = 0; i < count; i++) {
    enemies.push({
      x: random(300, 1100),
      y: random(300, 900),
      life: 5,
      cooldown: 0
    });
  }

  hearts.push({
    x: random(400, 1000),
    y: random(400, 800)
  });
}

/* =========================
   DRAW
========================= */
function draw() {
  background(0);

  camX = player.x - width / 2;
  camY = player.y - height / 2;

  push();
  translate(-camX, -camY);

  drawMaze();
  drawHearts();
  drawEnemies();
  drawFires();
  drawBullets();
  drawPlayer();

  pop();

  drawHUD();
}

/* =========================
   PLAYER
========================= */
function drawPlayer() {
  animFrame = (animFrame + 0.2) % 8;

  let moving =
    keyIsDown(65) || keyIsDown(68) ||
    keyIsDown(87) || keyIsDown(83);

  if (ammo <= 0) {
    drawSprite(catNoAmmo, player.x, player.y, 48, 48, floor(animFrame), 5);
  } else if (moving) {
    drawSprite(catMove, player.x, player.y, 48, 48, floor(animFrame), 8);
  } else {
    drawSprite(catIdle, player.x, player.y, 48, 48, floor(animFrame), 5);
  }

  if (keyIsDown(65)) player.x -= player.speed;
  if (keyIsDown(68)) player.x += player.speed;
  if (keyIsDown(87)) player.y -= player.speed;
  if (keyIsDown(83)) player.y += player.speed;
}

/* =========================
   TIRO DO HER√ìI
========================= */
function mousePressed() {
  if (ammo > 0) {
    bullets.push({
      x: player.x + 24,
      y: player.y + 24,
      dx: (mouseX - width / 2) * 0.05,
      dy: (mouseY - height / 2) * 0.05
    });
    ammo--;
  }
}

function drawBullets() {
  for (let i = bullets.length - 1; i >= 0; i--) {
    let b = bullets[i];
    b.x += b.dx;
    b.y += b.dy;
    image(bulletImg, b.x, b.y, 16, 16);

    for (let e of enemies) {
      if (dist(b.x, b.y, e.x, e.y) < 25) {
        e.life--;
        bullets.splice(i, 1);
        break;
      }
    }
  }
}

/* =========================
   INIMIGOS
========================= */
function drawEnemies() {
  for (let e of enemies) {
    let d = dist(player.x, player.y, e.x, e.y);

    if (d < 350) {
      e.x += (player.x - e.x) * 0.01;
      e.y += (player.y - e.y) * 0.01;
    }

    drawSprite(enemyFly, e.x, e.y, 48, 48, floor(frameCount / 8) % 4, 4);

    if (e.cooldown <= 0) {
      fires.push({
        x: e.x,
        y: e.y,
        dx: (player.x - e.x) * 0.03,
        dy: (player.y - e.y) * 0.03
      });
      e.cooldown = 120;
    } else {
      e.cooldown--;
    }
  }

  enemies = enemies.filter(e => e.life > 0);

  if (enemies.length === 0) {
    currentLevel++;
    loadLevel(currentLevel);
  }
}

/* =========================
   FOGO DO INIMIGO
========================= */
function drawFires() {
  for (let i = fires.length - 1; i >= 0; i--) {
    let f = fires[i];
    f.x += f.dx;
    f.y += f.dy;
    image(enemyFire, f.x, f.y, 20, 20);

    if (dist(f.x, f.y, player.x, player.y) < 25) {
      playerLife--;
      fires.splice(i, 1);
    }
  }
}

/* =========================
   CORA√á√ÉO (VIDA)
========================= */
function drawHearts() {
  for (let i = hearts.length - 1; i >= 0; i--) {
    let h = hearts[i];
    image(heartImg, h.x, h.y, 32, 32);

    if (dist(player.x, player.y, h.x, h.y) < 30) {
      playerLife = min(10, playerLife + 1);
      hearts.splice(i, 1);
    }
  }
}

/* =========================
   HUD
========================= */
function drawHUD() {
  fill(255);
  textSize(16);
  text("‚ù§Ô∏è Vida: " + playerLife, 20, 30);
  text("üî´ Ammo: " + ammo + "/" + maxAmmo, 20, 55);
  text("Stage: " + currentLevel, 20, 80);
}

/* =========================
   LABIRINTO
========================= */
function drawMaze() {
  stroke(80);
  strokeWeight(10);
  line(300, 200, 300, 900);
  line(600, 300, 1000, 300);
  line(900, 400, 900, 900);
  noStroke();
}
</script>

</body>
</html>
